title: چطور گلرا کلاستر خراب شده کامل یا ناقص را بازگردانی کنیم
briefing: مشکل خرابی کلاستر گلرا در دیتابیس، مشکلی مرسوم و متداول می باشد، در این مطلب خیلی ساده روش های بازگرداندن کلاسترینگ را بیان خواهیم کرد.
date_time: 2020-12-27 10:49
slug: Recover-MariaDB-Galera-Cluster
tags: linux, database, galera, galera_cluster, mariadb, cluster
type: post

## گلرا کلاستر

گلرا یک کلاسترینگ **همزمان و چند مستره** برای `MariaDB`، `Mysql` و `Percona-DB` می باشد.

معمولا در کلاسترینگ گلرا، با خرابی یا مشکل در یک نود، کلاسترینگ می تواند به کار خود ادامه دهد، اما با خرابی چند نود، کلاسترینگ نیز دچار مشکل شده و نمی توان به صحت عملکردش اعتماد کرد. دلایل ایجاد مشکل برای ارتباط بین نودهای کلاستر محدود به سخت افزار، شبکه، مشکلات نرم افزاری یا اشتباهات کاربری نمی باشد. اما خبر امیدوار کننده این است که در نهایت مشکل کلاستر، حداقل یک نود پایدار و در حال کار می ماند و این استمرار سرویس کلاستر می باشد. معمولا اتفاقی که بعد از خرابی یک نود می افتد این است که آن نود نمی تواند خود را مجددا به کلاستر متصل کند. 

### سناریوهای خرابی کلاستر

براساس تعداد نود مشکل خورده در کلاسترینگ، خرابی های کلاسترینگ گلرا را می توان به سناریوهای زیر دسته بندی کرد:

 * خرابی یک نود
 * خرابی چند نود
 * خرابی کامل کلاسترینگ

جدای از این سه سناریو، خرابی کلاستر موجب خرابی کامل ارتباط دیتابیس ها می گردد. در حالت نرمال، نودها برای به روز رسانی و نگهداری های متداول نیازمند ریست می باشند. زمانی که یک نود موفق ریست شود، خیلی ساده خود را به کلاستر متصل و اطلاعتش را با دیگر نودها همسان سازی می کند.

### بررسی سلامت کلاستر

برای شروع لازم است تا نحوه بررسی و چک کردن گلرا کلاستر را بدانیم. برای این مهم به ترتیب زیر عمل می کنیم:

    MariaDB [(none)]> show status like 'wsrep_incoming_addresses';
    +--------------------------+----------------------------------------------+
    | Variable_name | Value |
    +--------------------------+----------------------------------------------+
    | wsrep_incoming_addresses | 171.20.0.151:3306,171.20.0.152:3306,171.20.0.153:3306 |
    +--------------------------+----------------------------------------------+
    1 row in set (0.01 sec)

بررسی تعداد نودهای موجود در کلاسترینگ:

    MariaDB [(none)]> show status like 'wsrep_cluster_size';
    +--------------------+-------+
    | Variable_name | Value |
    +--------------------+-------+
    | wsrep_cluster_size | 3 |
    +--------------------+-------+
    1 row in set (0.01 sec)

بررسی `UUID` وضعیت کلاسترینگ:

    MariaDB [(none)]> show status like 'wsrep_cluster_state_uuid';
    +--------------------------+-----------------------------------------+
    | Variable_name | Value |
    +--------------------------+-----------------------------------------+
    | wsrep_cluster_state_uuid | 345098abd2-291a-9893-acbd3-30923abcdef9 |
    +--------------------------+-----------------------------------------+
    1 row in set (0.01 sec)

نحوه بررسی همسان بودن نود در کلاستر:

    MariaDB [(none)]> show status like 'wsrep_local_state_comment';
    +---------------------------+--------+
    | Variable_name | Value |
    +---------------------------+--------+
    | wsrep_local_state_comment | Synced |
    +---------------------------+--------+
    1 row in set (0.01 sec)
    
#### بازگرداندن سناریو یک نود

در این سناریو، فقط یک نود در کلاستر با مشکل مواجه شده است. هیچ اطلاعاتی از دست نرفته و هیچ ارتباطی بین دیتابیس ها مشکل نخورده است. طبق این سناریو، وضعیت به این صورت خواهد بود:

    MariaDB [(none)]> show status like 'wsrep_incoming_addresses';
    +--------------------------+-------------------------------+
    | Variable_name | Value |
    +--------------------------+-------------------------------+
    | wsrep_incoming_addresses | 171.20.0.151:3306,171.20.0.152:3306 |
    +--------------------------+-------------------------------+
    1 row in set (0.01 sec)

    MariaDB [(none)]> show status like 'wsrep_cluster_size';
    +--------------------+-------+
    | Variable_name | Value |
    +--------------------+-------+
    | wsrep_cluster_size | 2 |
    +--------------------+-------+
    1 row in set (0.01 sec)

بعد از ریست نود خراب شده، وضعیت آن را برای متصل شدن متصل شدن دوباره به کلاستر بررسی کنید. اگر به دلایلی وصل نشد خیلی ساده خود سرویس `MariaDB` را ریست کنید:

    $ systemctl restart mariadb

### سناریو مشکل چند نود در کلاستر

در این سناریو، تمامی نودها به غیر از یکی مشکل خورده اند که موجب از دست رفتن `quorum` می شود. در این نقطه، گلرا کلاستر درخواست های `SQL` را پاسخ نمی دهد. اما از آنجایی که هنوز یک نود بالا بوده و درحال اجرا می باشد، اطلاعاتی از دست نرفته است. در این حالت اگر نودهای مشکل خورده برای آنلاین شدن و اتصال به کلاستر تلاش کنند، نمی توانند موفق شوند چرا که کلاستر از دست رفته است:

    MariaDB [(none)]> show status like 'wsrep_cluster_size';
    +--------------------+-------+
    | Variable_name | Value |
    +--------------------+-------+
    | wsrep_cluster_size | 1 |
    +--------------------+-------+
    1 row in set (0.01 sec)

    MariaDB [(none)]> show status like 'wsrep_cluster_status';
    +----------------------+---------+
    | Variable_name | Value |
    +----------------------+---------+
    | wsrep_cluster_status | Primary |
    +----------------------+---------+
    1 row in set (0.01 sec)

در موارد نادر، ممکن است وضعیت کلاستر را `non-Primary` نشان دهد. اگر این اتفاق افتاد، علت خطا حتما از دست رفتن `quorum` نخواهد بود، بله احتمال بر قراری ارتباط شبکه می تواند باشد. توجه داشته باشید که قبل از بازسازی `quorum` حتما وضعیت نود به `Primary` تغییر کند. 

قبل از بازسازی `quorum` باید از آخرین `commit` را به دست بیاریم. برای این مهم دو راه وجود دارد:

#### Bootstrap خودکار

ساده ترین روش برای راه اندازی مجدد `quorum` استفاده از `bootstrap` خودکار است. به وسیله فرمان زیر می توان `bootstrap` خودکار را در نود فعال کرد:

    MariaDB [(none)]> set global wsrep_provider_options='pc.bootstrap=YES';

این فرمان موجب می شود تا نود جاری، به اصلی ترین نود خود راه انداز، تبدیل شده تا دیگر نودهای مشکل خورده بتوانند با اتصال به آن، خود را تصحیح کنند.

#### Bootstrap دستی

با اجرای دستورات زیر نود جاری به صورت دستی، تبدیل به خود راه انداز، خواهد شد:

    $ systemctl stop mariadb
    $ galera_new_cluster
    $ systemctl restart mariadb

بعد از این که این نود به عنوان نود اصلی راه اندازی و اجرا شد، کافی است تا سرویس `MaraiDB` روی دیگر نودها را یکی یکی ریست کرد.

## بازگرداندن کامل کلاستر

در این سناریو، تمامی نودها مشکل خورده یا به درستی خاموش نشده اند. کل اجزاء `quorum` از دست رفته و کلاستر دیگر هیچ درخواست `SQL` ای را پاسخگو نیست. در چنین حالتی، حتی اگر تمامی نودها آنلاین شوند سرویس `MariaDB` قادر به اجرا نیست. و این به علت خاموش شدن نادرست نودها بوده که هیچ کدام امکان اجرای آخرین کامیت را ندارند. براساس انواع خرابی هایی که به صورت کامل برای گلرا کلاستر اتفاق می افتد راهکارهای متفاوتی نیز وجود دارد.

### بازسازی براساس بیشترین مقدار seqno
 
این روش زمانی کاربردی هست که یک حداقل یک نود به صورت درست و کامل در حین خرابی خاموش شده باشد. نودی با داشتن آخرین دیتا دارای بیشترین مقدار `seqno` در بین تمامی نودهای خراب می باشد. این موضوع در فایل `/var/lib/mysql/grastate.dat` قابل مشاهده هست. بسته به این که کدام نود دچار خرابی کامل شده مقدار `seqno` یا منفی بوده و یا یکی از نودها حاوی بیشتر مقدار `seqno` می باشد. 

در ادامه محتویات فایل `grastate.dat` در ۳ نود را می توانید مشاهده کنید. معمولا حالت نشان داده شده به هنگام پردازش زبان تعریف داده `(DDL)` رخ می دهد:

    $ cat /var/lib/mysql/grastate.dat
    # GALERA saved state
    version: 2.1
    uuid: 00000000-0000-0000-0000-000000000000
    seqno: -1
    safe_to_bootstrap: 0
    
